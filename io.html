<html><head><title>fs2: I/O</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="co.fs2" /><meta name="description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="fs2: I/O" /><meta name="title" property="og:title" content="fs2: I/O" /><meta name="og:site_name" content="fs2" /><meta name="og:url" content="https://github.com/functional-streams-for-scala/fs2" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="fs2: I/O" /><meta name="twitter:image" content="/img/poster.png" /><meta name="twitter:description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/atom-one-light.css" /><link rel="stylesheet" href="/css/light-style.css" /></head><body class="page"><nav id="navigation" aria-labelledby="main-navigation"><div class="navbar-wrapper container"><div class="navigation-brand"><a href="/" class="brand custom-feature-icon"><div class="page-icon-wrapper"></div><span class="brand-title">fs2</span></a></div><div class="navigation-menu"><ul><li><a href="https://github.com/functional-streams-for-scala/fs2" target="_blank" rel="noopener noreferrer"><i class="nav-item-icon fa fa-lg fa-github" hidden="true"></i><span class="nav-item-text">GitHub</span></a></li></ul></div></div></nav><nav class="menu-container" aria-labelledby="section-navigation"><div id="horizontal-menu"><ul class="horizontal-nav"><li><a class="" href="/">Home</a></li><li><a class="" href="/guide.html">Guide</a></li><li><a class="" href="/concurrency-primitives.html">Concurrency Primitives</a></li><li><a class=" active " href="/io.html">I/O</a></li><li><a class="" href="/faq.html">FAQ</a></li><li><a class="" href="/documentation.html">Documentation</a></li><li><a class="" href="/ecosystem.html">Community</a></li></ul></div></nav><main id="site-main" class="page-site-main"><section class="use"><div class="container"><div id="content"><p>The <code class="highlighter-rouge">fs2-io</code> library provides support for performing input and output on the JVM (not Scala.js). This includes:</p>
<ul>
  <li><a href="#networking">Networking</a>
    <ul>
      <li><a href="#tcp">TCP</a></li>
      <li><a href="#udp">UDP</a></li>
      <li><a href="#tls">TLS</a></li>
    </ul>
  </li>
  <li><a href="#files">Files</a></li>
  <li><a href="#console-operations">Console operations</a></li>
  <li><a href="#java-stream-interop">Interop with <code class="highlighter-rouge">java.io.{InputStream, OutputStream}</code></a></li>
</ul>

<p>In this section, we’ll look at each of these features.</p>

<h1 id="networking">Networking</h1>

<p>The <code class="highlighter-rouge">fs2-io</code> library supports both TCP, via the <code class="highlighter-rouge">fs2.io.tcp</code> package, and UDP, via the <code class="highlighter-rouge">fs2.io.udp</code> package. Both packages provide purely functional abstractions on top of the Java NIO networking support. Furthermore, both packages take full advantage of the resource safety guarantees of cats-effect and <code class="highlighter-rouge">fs2.Stream</code>.</p>

<h2 id="tcp">TCP</h2>

<p>The <code class="highlighter-rouge">fs2.io.tcp.Socket</code> trait provides mechanisms for reading and writing data – both as individual actions and as part of stream programs.</p>

<h3 id="clients">Clients</h3>

<p>To get started, let’s write a client program that connects to a server, sends a message, and reads a response.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Chunk</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.io.tcp.</span><span class="o">{</span><span class="nc">Socket</span><span class="o">,</span> <span class="nc">SocketGroup</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Blocker</span><span class="o">,</span> <span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">Sync</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>

<span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">]</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nc">Blocker</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">use</span> <span class="o">{</span> <span class="n">blocker</span> <span class="k">=&gt;</span>
    <span class="nc">SocketGroup</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">blocker</span><span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">socketGroup</span> <span class="k">=&gt;</span>
      <span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">)).</span><span class="py">use</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">Chunk</span><span class="o">.</span><span class="py">bytes</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">.</span><span class="py">getBytes</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
          <span class="nv">socket</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="mi">8192</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
            <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>To open a socket that’s connected to <code class="highlighter-rouge">localhost:5555</code>, we need to use the <code class="highlighter-rouge">client</code> method on <code class="highlighter-rouge">SocketGroup</code>. Besides providing ways to create sockets, a <code class="highlighter-rouge">SocketGroup</code> provides a runtime environment for processing network events for the sockets it creates. Hence, the <code class="highlighter-rouge">apply</code> method of <code class="highlighter-rouge">SocketGroup</code> returns a <code class="highlighter-rouge">Resource[F, SocketGroup]</code>, which ensures the runtime environment is shutdown safely after usage of the group and all sockets created from it has finished. To create a <code class="highlighter-rouge">SocketGroup</code>, we needed a <code class="highlighter-rouge">Blocker</code>, which is also created inline here. Normally, a single <code class="highlighter-rouge">Blocker</code> and a single <code class="highlighter-rouge">SocketGroup</code> is created at startup and used for the lifetime of the application. To stress this, we can rewrite our TCP client example in this way:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">}</span>

<span class="k">object</span> <span class="nc">ClientApp</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Blocker</span><span class="o">[</span><span class="kt">IO</span><span class="o">].</span><span class="py">use</span> <span class="o">{</span> <span class="n">blocker</span> <span class="k">=&gt;</span>
      <span class="nc">SocketGroup</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">blocker</span><span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">socketGroup</span> <span class="k">=&gt;</span>
        <span class="n">client</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">socketGroup</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">}.</span><span class="py">as</span><span class="o">(</span><span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span><span class="o">)</span>

  <span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">)).</span><span class="py">use</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
      <span class="nv">socket</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">Chunk</span><span class="o">.</span><span class="py">bytes</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">.</span><span class="py">getBytes</span><span class="o">))</span> <span class="o">&gt;&gt;</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">read</span><span class="o">(</span><span class="mi">8192</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
          <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The <code class="highlighter-rouge">socketGroup.client</code> method returns a <code class="highlighter-rouge">Resource[F, Socket[F]]</code> which automatically closes the socket after the resource has been used. To write data to the socket, we call <code class="highlighter-rouge">socket.write</code>, which takes a <code class="highlighter-rouge">Chunk[Byte]</code> and returns an <code class="highlighter-rouge">F[Unit]</code>. Once the write completes, we do a single read from the socket via <code class="highlighter-rouge">socket.read</code>, passing the maximum amount of bytes we want to read. The returns an <code class="highlighter-rouge">F[Option[Chunk[Byte]]]</code> – <code class="highlighter-rouge">None</code> if the socket reaches end of input and <code class="highlighter-rouge">Some</code> if the read produced a chunk. Finally, we print the response to the console.</p>

<p>Note we aren’t doing any binary message framing or packetization in this example. Hence, it’s very possible for the single read to only receive a portion of the original message – perhaps just the bytes for <code class="highlighter-rouge">"Hello, w"</code>. We can use FS2 streams to simplify this. The <code class="highlighter-rouge">Socket</code> trait defines <code class="highlighter-rouge">Stream</code> operations  – <code class="highlighter-rouge">writes</code> and <code class="highlighter-rouge">reads</code>. We could rewrite this example using the stream operations like so:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.text</span>

<span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">))).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
    <span class="nc">Stream</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
      <span class="o">.</span><span class="py">drain</span> <span class="o">++</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">)</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
          <span class="o">.</span><span class="py">evalMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
            <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
          <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>The structure changes a bit. First, the socket resource is immediately lifted in to a stream via <code class="highlighter-rouge">Stream.resource</code>. Second, we create a single <code class="highlighter-rouge">Stream[Pure, String]</code>, transform it with <code class="highlighter-rouge">text.utf8Encode</code> to turn it in to a <code class="highlighter-rouge">Stream[Pure, Byte]</code>, and then transform it again with <code class="highlighter-rouge">socket.writes()</code> which turns it in to a <code class="highlighter-rouge">Stream[F, Unit]</code>. The <code class="highlighter-rouge">socket.writes</code> method returns a pipe that writes each underlying chunk of the input stream to the socket. The resulting stream is drained since we don’t use the unit values, giving us a <code class="highlighter-rouge">Stream[F, Nothing]</code>.</p>

<p>We then append a stream that reads a respnose – we do this via <code class="highlighter-rouge">socket.reads(8192)</code>, which gives us a <code class="highlighter-rouge">Stream[F, Byte]</code> that terminates when the socket is closed or it receives an end of input indication. We transform that stream with <code class="highlighter-rouge">text.utf8Decode</code>, which gives us a <code class="highlighter-rouge">Stream[F, String]</code>. We then print each received response to the console.</p>

<p>This program won’t end until the server side closes the socket or indicates there’s no more data to be read. To fix this, we need a protocol that both the client and server agree on. Since we are working with text, let’s use a simple protocol where each frame (or “packet” or “message”) is terminated with a <code class="highlighter-rouge">\n</code>. We’ll have to update both the write side and the read side of our client.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">))).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
    <span class="nc">Stream</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">interleave</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">constant</span><span class="o">(</span><span class="s">"\n"</span><span class="o">))</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
      <span class="o">.</span><span class="py">drain</span> <span class="o">++</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">)</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">lines</span><span class="o">)</span>
          <span class="o">.</span><span class="py">head</span>
          <span class="o">.</span><span class="py">evalMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
            <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
          <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>To update the write side, we added <code class="highlighter-rouge">.interleave(Stream.constant("\n"))</code> before doing UTF8 encoding. This results in every input string being followed by a <code class="highlighter-rouge">"\n"</code>. On the read side, we transformed the output of <code class="highlighter-rouge">utf8Decode</code> with <code class="highlighter-rouge">text.lines</code>, which emits the strings between newlines. Finally, we call <code class="highlighter-rouge">head</code> to take the first full line of output. Note that we discard the rest of the <code class="highlighter-rouge">reads</code> stream after processing the first full line. This results in the socket getting closed and cleaned up correctly.</p>

<h4 id="handling-connection-errors">Handling Connection Errors</h4>

<p>If a TCP connection cannot be established, <code class="highlighter-rouge">socketGroup.client</code> fails with a <code class="highlighter-rouge">java.net.ConnectException</code>. To automatically attempt a reconnection, we can handle the <code class="highlighter-rouge">ConnectException</code> and try connecting again.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">cats.effect.Timer</span>
<span class="k">import</span> <span class="nn">java.net.ConnectException</span>

<span class="k">def</span> <span class="nf">connect</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift:</span> <span class="kt">Timer</span><span class="o">](</span>
    <span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">,</span> 
    <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Socket</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="n">address</span><span class="o">))</span>
    <span class="o">.</span><span class="py">handleErrorWith</span> <span class="o">{</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">ConnectException</span> <span class="o">=&gt;</span>
        <span class="nf">connect</span><span class="o">(</span><span class="n">socketGroup</span><span class="o">,</span> <span class="n">address</span><span class="o">).</span><span class="py">delayBy</span><span class="o">(</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span>
    <span class="o">}</span>

<span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift:</span> <span class="kt">Timer</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nf">connect</span><span class="o">(</span><span class="n">socketGroup</span><span class="o">,</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">)).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
    <span class="nc">Stream</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">interleave</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">constant</span><span class="o">(</span><span class="s">"\n"</span><span class="o">))</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
      <span class="o">.</span><span class="py">drain</span> <span class="o">++</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">)</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">lines</span><span class="o">)</span>
          <span class="o">.</span><span class="py">head</span>
          <span class="o">.</span><span class="py">evalMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
            <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
          <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>We’ve extract the <code class="highlighter-rouge">socketGroup.client</code> call in to a new method called <code class="highlighter-rouge">connect</code>. The connect method attempts to create a client and handles the <code class="highlighter-rouge">ConnectException</code>. Upon encountering the exception, we call <code class="highlighter-rouge">connect</code> recursively after a 5 second delay. Because we are using <code class="highlighter-rouge">delayBy</code>, we needed to add a <code class="highlighter-rouge">Timer</code> constraint to <code class="highlighter-rouge">F</code>. This same pattern could be used for more advanced retry strategies – e.g., exponential delays and failing after a fixed number of attempts. Streams that call methods on <code class="highlighter-rouge">Socket</code> can fail with exceptions due to loss of the underlying TCP connection. Such exceptions can be handled in a similar manner.</p>

<h3 id="servers">Servers</h3>

<p>Now let’s implement a server application that communicates with the client app we just built. The server app will be a simple echo server – for each line of text it receives, it will reply with the same line.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">echoServer</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">socketGroup</span><span class="o">.</span><span class="py">server</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">5555</span><span class="o">)).</span><span class="py">map</span> <span class="o">{</span> <span class="n">clientResource</span> <span class="k">=&gt;</span>
    <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="n">clientResource</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">client</span> <span class="k">=&gt;</span>
      <span class="nv">client</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">)</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">lines</span><span class="o">)</span>
        <span class="o">.</span><span class="py">interleave</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">constant</span><span class="o">(</span><span class="s">"\n"</span><span class="o">))</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">client</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
    <span class="o">}</span>
  <span class="o">}.</span><span class="py">parJoin</span><span class="o">(</span><span class="mi">100</span><span class="o">).</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
</code></pre></div></div>

<p>We start with a call to <code class="highlighter-rouge">socketGroup.server</code> which returns a value of an interesting type – <code class="highlighter-rouge">Stream[F, Resource[F, Socket[F]]]</code>. This is an infinite stream of client connections – each time a client connects to the server, a <code class="highlighter-rouge">Resource[F, Socket[F]]</code> is emitted, allowing interaction with that client. The client socket is provided as a resource, allowing us to use the resource and then release it, closing the underlying socket and returning any acquired resources to the runtime environment.</p>

<p>We map over this infinite stream of clients and provide the logic for handling an individual client. In this case,
we read from the client socket, UTF-8 decode the received bytes, extract individual lines, and then write each line back to the client. This logic is implemented as a single <code class="highlighter-rouge">Stream[F, Unit]</code>.</p>

<p>Since we mapped over the infinite client stream, we end up with a <code class="highlighter-rouge">Stream[F, Stream[F, Unit]]</code>. We flatten this to a single <code class="highlighter-rouge">Stream[F, Unit]</code> via <code class="highlighter-rouge">parJoin(100)</code>, which runs up to 100 of the inner streams concurrently. As inner streams finish, new inner streams are pulled from the source. Hence, <code class="highlighter-rouge">parJoin</code> is controlling the maximum number of concurrent client requests our server processes.</p>

<p>The pattern of <code class="highlighter-rouge">socketGroup.server(address).map(handleClient).parJoin(maxConcurrentClients)</code> is very common when working with server sockets.</p>

<p>A simpler echo server could be implemented with this core logic:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">client</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nv">client</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
</code></pre></div></div>

<p>However, such an implementation would echo bytes back to the client as they are received instead of only echoing back full lines of text.</p>

<p>The <a href="https://github.com/functional-streams-for-scala/fs2-chat">fs2-chat</a> sample application implements a multiuser chat server and a single user chat client using the FS2 TCP support and <a href="https://scodec.org">scodec</a> for binary processing.</p>

<h2 id="udp">UDP</h2>

<p>UDP support works much the same way as TCP. The <code class="highlighter-rouge">fs2.io.udp.Socket</code> trait provides mechanisms for reading and writing UDP datagrams. UDP sockets are created via the <code class="highlighter-rouge">open</code> method on <code class="highlighter-rouge">fs2.io.udp.SocketGroup</code>. Unlike TCP, there’s no differentiation between client and server sockets. Additionally, since UDP is a packet based protocol, read and write operations use <code class="highlighter-rouge">fs2.io.udp.Packet</code> values, which consist of a <code class="highlighter-rouge">Chunk[Byte]</code> and an <code class="highlighter-rouge">InetSocketAddress</code>. A packet is equivalent to a UDP datagram.</p>

<p>Adapting the TCP client example for UDP gives us the following:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Chunk</span><span class="o">,</span> <span class="n">text</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.io.udp.</span><span class="o">{</span><span class="nc">Packet</span><span class="o">,</span> <span class="nc">Socket</span><span class="o">,</span> <span class="nc">SocketGroup</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">Sync</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>

<span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">address</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">)</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">open</span><span class="o">()).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
    <span class="nc">Stream</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">)</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
      <span class="o">.</span><span class="py">chunks</span>
      <span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">data</span> <span class="k">=&gt;</span> <span class="nc">Packet</span><span class="o">(</span><span class="n">address</span><span class="o">,</span> <span class="n">data</span><span class="o">))</span>
      <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
      <span class="o">.</span><span class="py">drain</span> <span class="o">++</span>
        <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">()</span>
          <span class="o">.</span><span class="py">flatMap</span><span class="o">(</span><span class="n">packet</span> <span class="k">=&gt;</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">chunk</span><span class="o">(</span><span class="nv">packet</span><span class="o">.</span><span class="py">bytes</span><span class="o">))</span>
          <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
          <span class="o">.</span><span class="py">evalMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
            <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
          <span class="o">}</span>
  <span class="o">}.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
<span class="o">}</span>
</code></pre></div></div>

<p>When writing, we map each chunk of bytes to a <code class="highlighter-rouge">Packet</code>, which includes the destination address of the packet. When reading, we convert the <code class="highlighter-rouge">Stream[F, Packet]</code> to a <code class="highlighter-rouge">Stream[F, Byte]</code> via <code class="highlighter-rouge">flatMap(packet =&gt; Stream.chunk(packet.bytes))</code>. Otherwise, the example is unchanged.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">echoServer</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">open</span><span class="o">(</span><span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="mi">5555</span><span class="o">))).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
    <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">().</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
  <span class="o">}.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span>
</code></pre></div></div>

<p>The UDP server implementation is much different than the TCP server implementation. We open a socket that’s bound to port <code class="highlighter-rouge">5555</code>. We then read packets from that socket, writing each packet back out. Since each received packet has the remote address of the sender, we can reuse the same packet for writing.</p>

<h2 id="tls">TLS</h2>

<p>The <code class="highlighter-rouge">fs2.io.tls</code> package provides support for TLS over TCP and DTLS over UDP, built on top of <code class="highlighter-rouge">javax.net.ssl</code>. TLS over TCP is provided by the <code class="highlighter-rouge">TLSSocket</code> trait, which is instantiated by methods on <code class="highlighter-rouge">TLSContext</code>. A <code class="highlighter-rouge">TLSContext</code> provides cryptographic material used in TLS session establishment – e.g., the set of certificates that are trusted (sometimes referred to as a trust store) and optionally, the set of certificates identifying this application (sometimes referred to as a key store). The <code class="highlighter-rouge">TLSContext</code> companion provides many ways to construct a <code class="highlighter-rouge">TLSContext</code> – for example:</p>
<ul>
  <li><code class="highlighter-rouge">TLSContext.system(blocker)</code> - delegates to <code class="highlighter-rouge">javax.net.ssl.SSLContext.getDefault</code>, which uses the JDK default set of trusted certificates</li>
  <li><code class="highlighter-rouge">TLSContext.fromKeyStoreFile(pathToFile, storePassword, keyPassword, blocker)</code> - loads a Java Key Store file</li>
  <li><code class="highlighter-rouge">TLSContext.insecure(blocker)</code> - trusts all certificates - note: this is dangerously insecure - only use for quick tests</li>
</ul>

<p>A <code class="highlighter-rouge">TLSContext</code> is typically created at application startup and used for all sockets for the lifetime of the application. Once a <code class="highlighter-rouge">TLSContext</code> has been created, the <code class="highlighter-rouge">client</code> and <code class="highlighter-rouge">server</code> methods are used to create <code class="highlighter-rouge">TLSSocket</code> instances (and <code class="highlighter-rouge">dtlsClient</code> / <code class="highlighter-rouge">dtlsServer</code> methods for <code class="highlighter-rouge">DTLSSocket</code>). In each case, a regular socket must be provided, which the <code class="highlighter-rouge">TLSSocket</code> will use for performing the TLS handshake as well as transmitting and receiving encrypted data. <code class="highlighter-rouge">TLSSocket</code> extends <code class="highlighter-rouge">fs2.io.tcp.Socket</code>, making the addition of TLS support a drop in replacement for a program using <code class="highlighter-rouge">fs2-io</code>.</p>

<p>Adapting the TCP echo client for TLS looks like this:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Chunk</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">,</span> <span class="n">text</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.io.tcp.SocketGroup</span>
<span class="k">import</span> <span class="nn">fs2.io.tls.TLSContext</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ContextShift</span><span class="o">,</span> <span class="nc">Sync</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">java.net.InetSocketAddress</span>

<span class="k">def</span> <span class="nf">client</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span>
  <span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">,</span>
  <span class="n">tlsContext</span><span class="k">:</span> <span class="kt">TLSContext</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
  <span class="k">val</span> <span class="nv">address</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">InetSocketAddress</span><span class="o">(</span><span class="s">"localhost"</span><span class="o">,</span> <span class="mi">5555</span><span class="o">)</span>
  <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="n">address</span><span class="o">)).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">underlyingSocket</span> <span class="k">=&gt;</span>
    <span class="nv">Stream</span><span class="o">.</span><span class="py">resource</span><span class="o">(</span><span class="nv">tlsContext</span><span class="o">.</span><span class="py">client</span><span class="o">(</span><span class="n">underlyingSocket</span><span class="o">)).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">socket</span> <span class="k">=&gt;</span>
      <span class="nc">Stream</span><span class="o">(</span><span class="s">"Hello, world!"</span><span class="o">)</span>
        <span class="o">.</span><span class="py">interleave</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">constant</span><span class="o">(</span><span class="s">"\n"</span><span class="o">))</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Encode</span><span class="o">)</span>
        <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">socket</span><span class="o">.</span><span class="py">writes</span><span class="o">())</span>
        <span class="o">.</span><span class="py">drain</span> <span class="o">++</span>
          <span class="nv">socket</span><span class="o">.</span><span class="py">reads</span><span class="o">(</span><span class="mi">8192</span><span class="o">)</span>
            <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">utf8Decode</span><span class="o">)</span>
            <span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">text</span><span class="o">.</span><span class="py">lines</span><span class="o">)</span>
            <span class="o">.</span><span class="py">head</span>
            <span class="o">.</span><span class="py">evalMap</span> <span class="o">{</span> <span class="n">response</span> <span class="k">=&gt;</span>
              <span class="nc">Sync</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Response: $response"</span><span class="o">))</span>
            <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>The only difference is that we wrap the underlying socket with a <code class="highlighter-rouge">TLSSocket</code>.</p>

<h3 id="configuring-tls-session-parameters">Configuring TLS Session Parameters</h3>

<p>The various methods on <code class="highlighter-rouge">TLSContext</code> that create <code class="highlighter-rouge">TLSSocket</code>s and <code class="highlighter-rouge">DTLSSocket</code>s all take a <code class="highlighter-rouge">TLSParameters</code> argument, allowing session level configuration. This allows configuration of things like client authentication, supported protocols and cipher suites, and SNI extensions. For example:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">fs2.io.tls.</span><span class="o">{</span><span class="nc">TLSParameters</span><span class="o">,</span> <span class="nc">TLSSocket</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.effect.Resource</span>
<span class="k">import</span> <span class="nn">javax.net.ssl.SNIHostName</span>

<span class="k">def</span> <span class="nf">tlsClientWithSni</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span>
  <span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">,</span>
  <span class="n">tlsContext</span><span class="k">:</span> <span class="kt">TLSContext</span><span class="o">,</span>
  <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span><span class="o">)</span><span class="k">:</span> <span class="kt">Resource</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">TLSSocket</span><span class="o">[</span><span class="kt">F</span><span class="o">]]</span> <span class="k">=</span>
  <span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">address</span><span class="o">).</span><span class="py">flatMap</span> <span class="o">{</span> <span class="n">underlyingSocket</span> <span class="k">=&gt;</span>
    <span class="nv">tlsContext</span><span class="o">.</span><span class="py">client</span><span class="o">(</span>
      <span class="n">underlyingSocket</span><span class="o">,</span>
      <span class="nc">TLSParameters</span><span class="o">(</span>
        <span class="n">protocols</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="s">"TLSv1.3"</span><span class="o">)),</span>
        <span class="n">serverNames</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="k">new</span> <span class="nc">SNIHostName</span><span class="o">(</span><span class="nv">address</span><span class="o">.</span><span class="py">getHostName</span><span class="o">)))</span>
      <span class="o">)</span>
    <span class="o">)</span>
  <span class="o">}</span>
</code></pre></div></div>

<p>In this example, we’ve configured the TLS session to require TLS 1.3 and we’ve added an SNI extension with the hostname of the target server.</p>

<h3 id="accessing-tls-session-information">Accessing TLS Session Information</h3>

<p><code class="highlighter-rouge">TLSSocket</code> extends <code class="highlighter-rouge">Socket</code> and provides a few additional methods. One particularly interesting method is <code class="highlighter-rouge">session</code>, which returns a <code class="highlighter-rouge">F[javax.net.ssl.SSLSession]</code>, containing information about the established TLS session. This allows us to query for things like the peer certificate or the cipher suite that was negotiated.</p>

<p>In the following example, we extract various information about the session, in order to help debug TLS connections.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">debug</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">ContextShift</span><span class="o">](</span>
    <span class="n">socketGroup</span><span class="k">:</span> <span class="kt">SocketGroup</span><span class="o">,</span>
    <span class="n">tlsContext</span><span class="k">:</span> <span class="kt">TLSContext</span><span class="o">,</span>
    <span class="n">address</span><span class="k">:</span> <span class="kt">InetSocketAddress</span>
<span class="o">)</span><span class="k">:</span> <span class="kt">F</span><span class="o">[</span><span class="kt">String</span><span class="o">]</span> <span class="k">=</span>
  <span class="nv">socketGroup</span><span class="o">.</span><span class="py">client</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="n">address</span><span class="o">).</span><span class="py">use</span> <span class="o">{</span> <span class="n">underlyingSocket</span> <span class="k">=&gt;</span>
    <span class="n">tlsContext</span>
      <span class="o">.</span><span class="py">client</span><span class="o">(</span>
        <span class="n">underlyingSocket</span><span class="o">,</span>
        <span class="nc">TLSParameters</span><span class="o">(</span><span class="n">serverNames</span> <span class="k">=</span> <span class="nc">Some</span><span class="o">(</span><span class="nc">List</span><span class="o">(</span><span class="k">new</span> <span class="nc">SNIHostName</span><span class="o">(</span><span class="nv">address</span><span class="o">.</span><span class="py">getHostName</span><span class="o">))))</span>
      <span class="o">)</span>
      <span class="o">.</span><span class="py">use</span> <span class="o">{</span> <span class="n">tlsSocket</span> <span class="k">=&gt;</span>
        <span class="nv">tlsSocket</span><span class="o">.</span><span class="py">write</span><span class="o">(</span><span class="nv">Chunk</span><span class="o">.</span><span class="py">empty</span><span class="o">)</span> <span class="o">&gt;&gt;</span>
          <span class="nv">tlsSocket</span><span class="o">.</span><span class="py">session</span><span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="n">session</span> <span class="k">=&gt;</span>
            <span class="n">s</span><span class="s">"Cipher suite: ${session.getCipherSuite}\r\n"</span> <span class="o">+</span>
              <span class="s">"Peer certificate chain:\r\n"</span> <span class="o">+</span> <span class="nv">session</span><span class="o">.</span><span class="py">getPeerCertificates</span><span class="o">.</span><span class="py">zipWithIndex</span>
              <span class="o">.</span><span class="py">map</span> <span class="o">{</span> <span class="nf">case</span> <span class="o">(</span><span class="n">cert</span><span class="o">,</span> <span class="n">idx</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">s</span><span class="s">"Certificate $idx: $cert"</span> <span class="o">}</span>
              <span class="o">.</span><span class="py">mkString</span><span class="o">(</span><span class="s">"\r\n"</span><span class="o">)</span>
          <span class="o">}</span>
      <span class="o">}</span>
  <span class="o">}</span>
</code></pre></div></div>

<h1 id="files">Files</h1>

<p>The <code class="highlighter-rouge">fs2.io.file</code> package provides support for working with files. The README example demonstrates the two simplest use cases – incrementally reading from a file with <code class="highlighter-rouge">fs2.io.file.readAll</code> and incrementally writing to a file with <code class="highlighter-rouge">fs2.io.file.writeAll</code>.</p>

<p>For more complex use cases, there are a few types available – <code class="highlighter-rouge">FileHandle</code>, <code class="highlighter-rouge">ReadCursor</code>, and <code class="highlighter-rouge">WriteCursor</code>. A <code class="highlighter-rouge">FileHandle[F]</code> represents an open file and provides various methods for interacting with the file – reading data, writing data, querying the size, etc. – all in the effect <code class="highlighter-rouge">F</code>. Constructing a <code class="highlighter-rouge">FileHandle[F]</code> is accomplished by calling <code class="highlighter-rouge">FileHandle.fromPath(path, blocker)</code>, passing a <code class="highlighter-rouge">java.nio.file.Path</code> value indicating which file to open.</p>

<p>The <code class="highlighter-rouge">ReadCursor</code> type pairs a <code class="highlighter-rouge">FileHandle[F]</code> with a byte offset in to the file. The methods on <code class="highlighter-rouge">ReadCursor</code> provide read operations that start at the current offset and return an updated cursor along with whatever data was read.</p>

<p>Similarly, <code class="highlighter-rouge">WriteCursor</code> pairs a <code class="highlighter-rouge">FileHandle[F]</code> with a byte offset. The methods on <code class="highlighter-rouge">WriteCursor</code> use the offset as the position to write the next chunk of bytes, returning an updated cursor.</p>

<p>The <code class="highlighter-rouge">fs2.io.file</code> package object also provides many ways to interact with the file system – moving files, creating directories, walking all paths in a diretory tree, watching directories for changes, etc.</p>

<h1 id="console-operations">Console Operations</h1>

<p>Writing to the console is often as simple as <code class="highlighter-rouge">s.evalMap(o =&gt; IO(println(o)))</code>. This works fine for quick tests but can be problematic in large applications. The call to <code class="highlighter-rouge">println</code> blocks until data can be written to the output stream for standard out. This can cause fairness issues with other, non-blocking, operations running on the main thread pool. For such situations, <code class="highlighter-rouge">fs2-io</code> provides a couple of utilities:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">stdoutLines</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">ContextShift</span>, <span class="kt">O:</span> <span class="kt">Show</span><span class="o">](</span>
    <span class="n">blocker</span><span class="k">:</span> <span class="kt">Blocker</span><span class="o">,</span>
    <span class="n">charset</span><span class="k">:</span> <span class="kt">Charset</span> <span class="o">=</span> <span class="n">utf8Charset</span>
<span class="o">)</span><span class="k">:</span> <span class="kt">Pipe</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">O</span>, <span class="kt">Unit</span><span class="o">]</span>

<span class="k">def</span> <span class="nf">stdout</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">blocker</span><span class="k">:</span> <span class="kt">Blocker</span><span class="o">)</span><span class="k">:</span> <span class="kt">Pipe</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Byte</span>, <span class="kt">Unit</span><span class="o">]</span>
</code></pre></div></div>

<p>Both of these pipes are provided in the <code class="highlighter-rouge">fs2.io</code> package object. Both wrap calls to the console with a <code class="highlighter-rouge">blocker.delay</code> to avoid fairness issues. The <code class="highlighter-rouge">stdoutLines</code> method uses a <code class="highlighter-rouge">Show[O]</code> instance to convert the stream elements to strings. Note these pipes may be more expensive than simplying doing a blocking println, depending on the application. We’re trading fairness for the overhead of shifting execution to a blocking thread pool.</p>

<p>The <code class="highlighter-rouge">fs2.io</code> package object also provides a couple of utilities for reading values from the console:</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">stdin</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">bufSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">blocker</span><span class="k">:</span> <span class="kt">Blocker</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Byte</span><span class="o">]</span>

<span class="k">def</span> <span class="nf">stdinUtf8</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Sync:</span> <span class="kt">ContextShift</span><span class="o">](</span><span class="n">bufSize</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span> <span class="n">blocker</span><span class="k">:</span> <span class="kt">Blocker</span><span class="o">)</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">String</span><span class="o">]</span>
</code></pre></div></div>

<p>Like the output variants, these operations perform blocking reads on a blocking pool.</p>

<h1 id="java-stream-interop">Java Stream Interop</h1>

<p>The <code class="highlighter-rouge">fs2.io</code> package object provides interop with <code class="highlighter-rouge">java.io.InputStream</code> and <code class="highlighter-rouge">java.io.OutputStream</code>.</p>

<p>The <code class="highlighter-rouge">fs2.io.readInputStream</code> method (and <code class="highlighter-rouge">unsafeReadInputStream</code> method, see ScalaDoc for differences) creates a <code class="highlighter-rouge">Stream[F, Byte]</code> from an <code class="highlighter-rouge">InputStream</code>.</p>

<p>The <code class="highlighter-rouge">fs2.io.writeOutputStream</code> method provides a pipe that writes the bytes emitted from a <code class="highlighter-rouge">Stream[F, Byte]</code> to an <code class="highlighter-rouge">OutputStream</code>.</p>

<p>The <code class="highlighter-rouge">fs2.io.readOutputStream</code> method creates a <code class="highlighter-rouge">Stream[F, Byte]</code> from a function which writes to an <code class="highlighter-rouge">OutputStream</code>.</p>
</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><p>fs2 is designed and developed by <a href="https://github.com/functional-streams-for-scala/fs2" target="_blank" rel="noopener noreferrer">co.fs2</a></p></div><div class="row"><div><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank" rel="noopener noreferrer">sbt-microsites</a> - © 2019 <a href="https://www.47deg.com/" target="_blank" rel="noopener noreferrer">47 Degrees</a></p></div></div></div></footer><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
              </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'functional-streams-for-scala/fs2'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/version-selector.js"></script></body></html>