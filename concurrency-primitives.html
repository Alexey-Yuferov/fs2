<html><head><title>fs2: Concurrency Primitives</title><meta charset="utf-8" /><meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="author" content="co.fs2" /><meta name="description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><meta name="og:image" content="/img/poster.png" /><meta name="image" property="og:image" content="/img/poster.png" /><meta name="og:title" content="fs2: Concurrency Primitives" /><meta name="title" property="og:title" content="fs2: Concurrency Primitives" /><meta name="og:site_name" content="fs2" /><meta name="og:url" content="https://github.com/functional-streams-for-scala/fs2" /><meta name="og:type" content="website" /><meta name="og:description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><link rel="icon" type="image/png" href="/img/favicon.png" /><meta name="twitter:title" content="fs2: Concurrency Primitives" /><meta name="twitter:image" content="/img/poster.png" /><meta name="twitter:description" content="Purely functional, effectful, resource-safe, concurrent streams for Scala" /><meta name="twitter:card" content="summary_large_image" /><link rel="icon" type="image/png" sizes="16x16" href="/img/favicon16x16.png" /><link rel="icon" type="image/png" sizes="24x24" href="/img/favicon24x24.png" /><link rel="icon" type="image/png" sizes="32x32" href="/img/favicon32x32.png" /><link rel="icon" type="image/png" sizes="48x48" href="/img/favicon48x48.png" /><link rel="icon" type="image/png" sizes="57x57" href="/img/favicon57x57.png" /><link rel="icon" type="image/png" sizes="60x60" href="/img/favicon60x60.png" /><link rel="icon" type="image/png" sizes="64x64" href="/img/favicon64x64.png" /><link rel="icon" type="image/png" sizes="70x70" href="/img/favicon70x70.png" /><link rel="icon" type="image/png" sizes="72x72" href="/img/favicon72x72.png" /><link rel="icon" type="image/png" sizes="76x76" href="/img/favicon76x76.png" /><link rel="icon" type="image/png" sizes="96x96" href="/img/favicon96x96.png" /><link rel="icon" type="image/png" sizes="114x114" href="/img/favicon114x114.png" /><link rel="icon" type="image/png" sizes="120x120" href="/img/favicon120x120.png" /><link rel="icon" type="image/png" sizes="128x128" href="/img/favicon128x128.png" /><link rel="icon" type="image/png" sizes="144x144" href="/img/favicon144x144.png" /><link rel="icon" type="image/png" sizes="150x150" href="/img/favicon150x150.png" /><link rel="icon" type="image/png" sizes="152x152" href="/img/favicon152x152.png" /><link rel="icon" type="image/png" sizes="196x196" href="/img/favicon196x196.png" /><link rel="icon" type="image/png" sizes="310x310" href="/img/favicon310x310.png" /><link rel="icon" type="image/png" sizes="310x150" href="/img/favicon310x150.png" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" /><link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" /><link rel="stylesheet" href="/highlight/styles/solarized-light.css" /><link rel="stylesheet" href="/css/pattern-style.css" /></head><body><header id="site-header"><div class="navbar-wrapper navbar-inverse"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="brand"><div class="icon-wrapper"><span>fs2</span></div></a></div><nav class="text-right"><ul class=""><li><a href="https://github.com/functional-streams-for-scala/fs2" target="_blank" rel="noopener noreferrer"><i class="fa fa-github"></i><span class="hidden-xs">GitHub</span></a></li></ul></nav></div></div><div class="jumbotron" style="background-image:url('/img/jumbotron_pattern.png')"></div><div id="horizontal-menu"><ul class="horizontal-nav"><li><a class="" href="/">Home</a></li><li><a class="" href="/guide.html">Guide</a></li><li><a class=" active " href="/concurrency-primitives.html">Concurrency Primitives</a></li><li><a class="" href="/faq.html">FAQ</a></li><li><a class="" href="/documentation.html">Documentation and References</a></li><li><a class="" href="/ecosystem.html">Library Ecosystem and Community</a></li></ul></div></header><main id="site-main" class="page-site-main"><section class="use"><div class="container"><div id="content"><h1 id="concurrency-primitives">Concurrency Primitives</h1>

<p>In the <a href="https://github.com/functional-streams-for-scala/fs2/blob/series/1.0/core/shared/src/main/scala/fs2/concurrent/"><code class="highlighter-rouge">fs2.concurrent</code> package</a> youâ€™ll find a bunch of useful concurrency primitives built on the concurrency primitives defined in <code class="highlighter-rouge">cats.effect.concurrent</code>:</p>

<ul>
  <li><code class="highlighter-rouge">Queue[F, A]</code></li>
  <li><code class="highlighter-rouge">Topic[F, A]</code></li>
  <li><code class="highlighter-rouge">Signal[F, A]</code></li>
</ul>

<p>These data structures could be very handy in a few cases. See below examples of each of them originally taken from <a href="https://github.com/gvolpe/advanced-http4s/tree/master/src/main/scala/com/github/gvolpe/fs2">gvolpe examples</a>:</p>

<h3 id="fifo-first-in--first-out">FIFO (First IN / First OUT)</h3>

<p>A typical use case of a <code class="highlighter-rouge">fs2.concurrent.Queue[F, A]</code>, also quite useful to communicate with the external world as shown in the <a href="guide.md#talking-to-the-external-world">guide</a>.</p>

<p>q1 has a buffer size of 1 while q2 has a buffer size of 100 so you will notice the buffering when  pulling elements out of the q2.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">,</span> <span class="nc">Timer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.concurrent.Queue</span>
<span class="k">import</span> <span class="nn">fs2.Stream</span>

<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">class</span> <span class="nc">Buffering</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">q1</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">],</span> <span class="n">q2</span><span class="k">:</span> <span class="kt">Queue</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Int</span><span class="o">])(</span><span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Concurrent</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">start</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
    <span class="nc">Stream</span><span class="o">(</span>
      <span class="nv">Stream</span><span class="o">.</span><span class="py">range</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="mi">1000</span><span class="o">).</span><span class="py">covary</span><span class="o">[</span><span class="kt">F</span><span class="o">].</span><span class="py">through</span><span class="o">(</span><span class="nv">q1</span><span class="o">.</span><span class="py">enqueue</span><span class="o">),</span>
      <span class="nv">q1</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nv">q2</span><span class="o">.</span><span class="py">enqueue</span><span class="o">),</span>
      <span class="c1">//.map won't work here as you're trying to map a pure value with a side effect. Use `evalMap` instead.</span>
      <span class="nv">q2</span><span class="o">.</span><span class="py">dequeue</span><span class="o">.</span><span class="py">evalMap</span><span class="o">(</span><span class="n">n</span> <span class="k">=&gt;</span> <span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Pulling out $n from Queue #2"</span><span class="o">)))</span>
    <span class="o">).</span><span class="py">parJoin</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Fifo</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">stream</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="n">q1</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">Queue</span><span class="o">.</span><span class="py">bounded</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">1</span><span class="o">))</span>
      <span class="n">q2</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">Queue</span><span class="o">.</span><span class="py">bounded</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Int</span><span class="o">](</span><span class="mi">100</span><span class="o">))</span>
      <span class="n">bp</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">Buffering</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">q1</span><span class="o">,</span> <span class="n">q2</span><span class="o">)</span>
      <span class="k">_</span>  <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">sleep_</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="mf">5.</span><span class="n">seconds</span><span class="o">)</span> <span class="n">concurrently</span> <span class="nv">bp</span><span class="o">.</span><span class="py">start</span><span class="o">.</span><span class="py">drain</span>
    <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
    <span class="nv">stream</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">.</span><span class="py">as</span><span class="o">(</span><span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="single-publisher--multiple-subscriber">Single Publisher / Multiple Subscriber</h3>

<p>Having a Kafka like system built on top of concurrency primitives is possible by making use of <code class="highlighter-rouge">fs2.concurrent.Topic[F, A]</code>. In this more complex example, we will also show you how to make use of a <code class="highlighter-rouge">fs2.concurrent.Signal[F, A]</code> to interrupt a scheduled Stream.</p>

<p>The program ends after 15 seconds when the signal interrupts the publishing of more events given that the final streaming merge halts on the end of its left stream (the publisher).</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- Subscriber #1 should receive 15 events + the initial empty event
- Subscriber #2 should receive 10 events
- Subscriber #3 should receive 5 events
- Publisher sends Quit event
- Subscribers raise interrupt signal on Quit event
</code></pre></div></div>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>
<span class="k">import</span> <span class="nn">scala.language.higherKinds</span>
<span class="k">import</span> <span class="nn">java.util.concurrent.TimeUnit</span>
<span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">,</span> <span class="nc">Timer</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.syntax.all._</span>
<span class="k">import</span> <span class="nn">fs2.</span><span class="o">{</span><span class="nc">Pipe</span><span class="o">,</span> <span class="nc">Stream</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">fs2.concurrent.</span><span class="o">{</span><span class="nc">SignallingRef</span><span class="o">,</span> <span class="nc">Topic</span><span class="o">}</span>

<span class="k">sealed</span> <span class="k">trait</span> <span class="nc">Event</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">Text</span><span class="o">(</span><span class="n">value</span><span class="k">:</span> <span class="kt">String</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Event</span>
<span class="k">case</span> <span class="k">object</span> <span class="nc">Quit</span> <span class="k">extends</span> <span class="nc">Event</span>

<span class="k">class</span> <span class="nc">EventService</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]](</span><span class="n">eventsTopic</span><span class="k">:</span> <span class="kt">Topic</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">],</span> <span class="n">interrupter</span><span class="k">:</span> <span class="kt">SignallingRef</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Boolean</span><span class="o">])(</span>
  <span class="k">implicit</span> <span class="n">F</span><span class="k">:</span> <span class="kt">Concurrent</span><span class="o">[</span><span class="kt">F</span><span class="o">],</span>
  <span class="n">timer</span><span class="k">:</span> <span class="kt">Timer</span><span class="o">[</span><span class="kt">F</span><span class="o">]</span>
<span class="o">)</span> <span class="o">{</span>

  <span class="c1">// Publishing 15 text events, then single Quit event, and still publishing text events</span>
  <span class="k">def</span> <span class="nf">startPublisher</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">textEvents</span> <span class="k">=</span> <span class="nv">eventsTopic</span><span class="o">.</span><span class="py">publish</span><span class="o">(</span>
      <span class="nv">Stream</span><span class="o">.</span><span class="py">awakeEvery</span><span class="o">[</span><span class="kt">F</span><span class="o">](</span><span class="mf">1.</span><span class="n">second</span><span class="o">)</span>
        <span class="o">.</span><span class="py">zipRight</span><span class="o">(</span><span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">timer</span><span class="o">.</span><span class="py">clock</span><span class="o">.</span><span class="py">realTime</span><span class="o">(</span><span class="nv">TimeUnit</span><span class="o">.</span><span class="py">MILLISECONDS</span><span class="o">).</span><span class="py">map</span><span class="o">(</span><span class="n">t</span> <span class="k">=&gt;</span> <span class="nc">Text</span><span class="o">(</span><span class="nv">t</span><span class="o">.</span><span class="py">toString</span><span class="o">))).</span><span class="py">repeat</span><span class="o">)</span>
    <span class="o">)</span>
  
    <span class="k">val</span> <span class="nv">quitEvent</span> <span class="k">=</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">eventsTopic</span><span class="o">.</span><span class="py">publish1</span><span class="o">(</span><span class="nc">Quit</span><span class="o">))</span>

    <span class="o">(</span><span class="nv">textEvents</span><span class="o">.</span><span class="py">take</span><span class="o">(</span><span class="mi">15</span><span class="o">)</span> <span class="o">++</span> <span class="n">quitEvent</span> <span class="o">++</span> <span class="n">textEvents</span><span class="o">).</span><span class="py">interruptWhen</span><span class="o">(</span><span class="n">interrupter</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="c1">// Creating 3 subscribers in a different period of time and join them to run concurrently</span>
  <span class="k">def</span> <span class="nf">startSubscribers</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">def</span> <span class="nf">processEvent</span><span class="o">(</span><span class="n">subscriberNumber</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span><span class="k">:</span> <span class="kt">Pipe</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span>
      <span class="nv">_</span><span class="o">.</span><span class="py">flatMap</span> <span class="o">{</span>
        <span class="k">case</span> <span class="n">e</span> <span class="k">@</span> <span class="nc">Text</span><span class="o">(</span><span class="k">_</span><span class="o">)</span> <span class="k">=&gt;</span>
           <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">F</span><span class="o">.</span><span class="py">delay</span><span class="o">(</span><span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"Subscriber #$subscriberNumber processing event: $e"</span><span class="o">)))</span>
       <span class="k">case</span> <span class="nc">Quit</span> <span class="k">=&gt;</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">interrupter</span><span class="o">.</span><span class="py">set</span><span class="o">(</span><span class="kc">true</span><span class="o">))</span>
     <span class="o">}</span>

    <span class="k">val</span> <span class="nv">events</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Event</span><span class="o">]</span> <span class="k">=</span>
      <span class="nv">eventsTopic</span><span class="o">.</span><span class="py">subscribe</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>

    <span class="nc">Stream</span><span class="o">(</span>
      <span class="nv">events</span><span class="o">.</span><span class="py">through</span><span class="o">(</span><span class="nf">processEvent</span><span class="o">(</span><span class="mi">1</span><span class="o">)),</span>
      <span class="nv">events</span><span class="o">.</span><span class="py">delayBy</span><span class="o">(</span><span class="mf">5.</span><span class="n">second</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nf">processEvent</span><span class="o">(</span><span class="mi">2</span><span class="o">)),</span>
      <span class="nv">events</span><span class="o">.</span><span class="py">delayBy</span><span class="o">(</span><span class="mf">10.</span><span class="n">second</span><span class="o">).</span><span class="py">through</span><span class="o">(</span><span class="nf">processEvent</span><span class="o">(</span><span class="mi">3</span><span class="o">))</span>
    <span class="o">).</span><span class="py">parJoin</span><span class="o">(</span><span class="mi">3</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">PubSub</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">val</span> <span class="nv">program</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
    <span class="n">topic</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nc">Topic</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Event</span><span class="o">](</span><span class="nc">Text</span><span class="o">(</span><span class="s">"Initial Event"</span><span class="o">)))</span>
    <span class="n">signal</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nc">SignallingRef</span><span class="o">[</span><span class="kt">IO</span>, <span class="kt">Boolean</span><span class="o">](</span><span class="kc">false</span><span class="o">))</span>
    <span class="n">service</span> <span class="k">=</span> <span class="k">new</span> <span class="nc">EventService</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="n">topic</span><span class="o">,</span> <span class="n">signal</span><span class="o">)</span>
    <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">service</span><span class="o">.</span><span class="py">startPublisher</span><span class="o">.</span><span class="py">concurrently</span><span class="o">(</span><span class="nv">service</span><span class="o">.</span><span class="py">startSubscribers</span><span class="o">)</span>
  <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span>
    <span class="nv">program</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">.</span><span class="py">as</span><span class="o">(</span><span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h3 id="shared-resource">Shared Resource</h3>

<p>When multiple processes try to access a precious resource you might want to constraint the number of accesses. Here is where <code class="highlighter-rouge">cats.effect.concurrent.Semaphore[F]</code> comes in useful.</p>

<p>Three processes are trying to access a shared resource at the same time but only one at a time will be granted access and the next process have to wait until the resource gets available again (availability is one as indicated by the semaphore counter).</p>

<p>R1, R2 &amp; R3 will request access of the precious resource concurrently so this could be one possible outcome:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>R1 &gt;&gt; Availability: 1
R2 &gt;&gt; Availability: 1
R2 &gt;&gt; Started | Availability: 0
R3 &gt;&gt; Availability: 0
--------------------------------
R1 &gt;&gt; Started | Availability: 0
R2 &gt;&gt; Done | Availability: 0
--------------------------------
R3 &gt;&gt; Started | Availability: 0
R1 &gt;&gt; Done | Availability: 0
--------------------------------
R3 &gt;&gt; Done | Availability: 1
</code></pre></div></div>

<p>This means when R1 and R2 requested the availability it was one and R2 was faster in getting access to the resource so it started processing. R3 was the slowest and saw that there was no availability from the beginning.</p>

<p>Once R2 was done R1 started processing immediately showing no availability.
Once R1 was done R3 started processing immediately showing no availability.
Finally, R3 was done showing an availability of one once again.</p>

<div class="language-scala highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="nn">cats.effect.</span><span class="o">{</span><span class="nc">Concurrent</span><span class="o">,</span> <span class="nc">ExitCode</span><span class="o">,</span> <span class="nc">IO</span><span class="o">,</span> <span class="nc">IOApp</span><span class="o">}</span>
<span class="k">import</span> <span class="nn">cats.effect.concurrent.Semaphore</span>
<span class="k">import</span> <span class="nn">cats.implicits._</span>
<span class="k">import</span> <span class="nn">fs2.Stream</span>

<span class="k">import</span> <span class="nn">scala.concurrent.ExecutionContext.Implicits.global</span>
<span class="k">import</span> <span class="nn">scala.concurrent.duration._</span>

<span class="k">class</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">F</span><span class="o">[</span><span class="k">_</span><span class="o">]</span><span class="kt">:</span> <span class="kt">Concurrent:</span> <span class="kt">Timer</span><span class="o">](</span><span class="n">name</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Semaphore</span><span class="o">[</span><span class="kt">F</span><span class="o">])</span> <span class="o">{</span>

  <span class="k">def</span> <span class="nf">use</span><span class="k">:</span> <span class="kt">Stream</span><span class="o">[</span><span class="kt">F</span>, <span class="kt">Unit</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">available</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Availability: $a"</span><span class="o">)))</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">acquire</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">available</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Started | Availability: $a"</span><span class="o">)))</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">sleep</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">release</span><span class="o">)</span>
      <span class="k">_</span> <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nv">s</span><span class="o">.</span><span class="py">available</span><span class="o">.</span><span class="py">map</span><span class="o">(</span><span class="n">a</span> <span class="k">=&gt;</span> <span class="nf">println</span><span class="o">(</span><span class="n">s</span><span class="s">"$name &gt;&gt; Done | Availability: $a"</span><span class="o">)))</span>
    <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">object</span> <span class="nc">Resources</span> <span class="k">extends</span> <span class="nc">IOApp</span> <span class="o">{</span>

  <span class="k">override</span> <span class="k">def</span> <span class="nf">run</span><span class="o">(</span><span class="n">args</span><span class="k">:</span> <span class="kt">List</span><span class="o">[</span><span class="kt">String</span><span class="o">])</span><span class="k">:</span> <span class="kt">IO</span><span class="o">[</span><span class="kt">ExitCode</span><span class="o">]</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="nv">stream</span> <span class="k">=</span> <span class="k">for</span> <span class="o">{</span>
      <span class="n">s</span>   <span class="k">&lt;-</span> <span class="nv">Stream</span><span class="o">.</span><span class="py">eval</span><span class="o">(</span><span class="nc">Semaphore</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="mi">1</span><span class="o">))</span>
      <span class="n">r1</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"R1"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
      <span class="n">r2</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"R2"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
      <span class="n">r3</span>  <span class="k">=</span> <span class="k">new</span> <span class="nc">PreciousResource</span><span class="o">[</span><span class="kt">IO</span><span class="o">](</span><span class="s">"R3"</span><span class="o">,</span> <span class="n">s</span><span class="o">)</span>
      <span class="k">_</span>   <span class="k">&lt;-</span> <span class="nc">Stream</span><span class="o">(</span><span class="nv">r1</span><span class="o">.</span><span class="py">use</span><span class="o">,</span> <span class="nv">r2</span><span class="o">.</span><span class="py">use</span><span class="o">,</span> <span class="nv">r3</span><span class="o">.</span><span class="py">use</span><span class="o">).</span><span class="py">parJoin</span><span class="o">(</span><span class="mi">3</span><span class="o">).</span><span class="py">drain</span>
    <span class="o">}</span> <span class="nf">yield</span> <span class="o">()</span>
    <span class="nv">stream</span><span class="o">.</span><span class="py">compile</span><span class="o">.</span><span class="py">drain</span><span class="o">.</span><span class="py">as</span><span class="o">(</span><span class="nv">ExitCode</span><span class="o">.</span><span class="py">Success</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>
</div></div></section></main><footer id="site-footer"><div class="container"><div class="row"><div class="col-xs-6"><p>fs2 is designed and developed by <a href="https://github.com/functional-streams-for-scala/fs2" target="_blank" rel="noopener noreferrer">co.fs2</a></p></div><div class="col-xs-6"><p class="text-right"><a href="https://github.com/functional-streams-for-scala/fs2" target="_blank" rel="noopener noreferrer"><span class="fa fa-github"></span>View on GitHub</a></p></div></div><div class="row"><div class="col-xs-6"><p>Website built with <a href="https://47deg.github.io/sbt-microsites/" target="_blank" rel="noopener noreferrer">sbt-microsites</a> - Â© 2019 <a href="https://www.47deg.com/" target="_blank" rel="noopener noreferrer">47 Degrees</a></p></div></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script><script src="/highlight/highlight.pack.js"></script><script>hljs.configure({languages:['scala','java','bash']});
hljs.initHighlightingOnLoad();
              </script><script>console.info('\x57\x65\x62\x73\x69\x74\x65\x20\x62\x75\x69\x6c\x74\x20\x77\x69\x74\x68\x3a\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x5f\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x5f\x20\x5f\x5f\x0a\x20\x20\x20\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x5f\x20\x20\x2f\x20\x2f\x5f\x20\x20\x20\x20\x20\x20\x5f\x5f\x5f\x5f\x20\x5f\x5f\x5f\x20\x20\x28\x5f\x29\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x28\x5f\x29\x20\x2f\x5f\x5f\x5f\x5f\x20\x20\x5f\x5f\x5f\x5f\x5f\x0a\x20\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x60\x5f\x5f\x20\x5c\x2f\x20\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x5f\x2f\x20\x5f\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x20\x2f\x20\x5f\x5f\x2f\x20\x5f\x20\x5c\x2f\x20\x5f\x5f\x5f\x2f\x0a\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x5f\x2f\x20\x2f\x20\x2f\x5f\x2f\x5f\x5f\x5f\x5f\x5f\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x20\x2f\x5f\x5f\x2f\x20\x2f\x20\x20\x2f\x20\x2f\x5f\x2f\x20\x28\x5f\x5f\x20\x20\x29\x20\x2f\x20\x2f\x5f\x2f\x20\x20\x5f\x5f\x28\x5f\x5f\x20\x20\x29\x0a\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2e\x5f\x5f\x5f\x2f\x5c\x5f\x5f\x2f\x20\x20\x20\x20\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x20\x2f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x2f\x20\x20\x20\x5c\x5f\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x5f\x2f\x5c\x5f\x5f\x2f\x5c\x5f\x5f\x5f\x2f\x5f\x5f\x5f\x5f\x2f\x0a\x0a\x68\x74\x74\x70\x73\x3a\x2f\x2f\x34\x37\x64\x65\x67\x2e\x67\x69\x74\x68\x75\x62\x2e\x69\x6f\x2f\x73\x62\x74\x2d\x6d\x69\x63\x72\x6f\x73\x69\x74\x65\x73')</script><script>((window.gitter = {}).chat = {}).options = {
room: 'functional-streams-for-scala/fs2'};</script><script src="https://sidecar.gitter.im/dist/sidecar.v1.js"></script><script src="/js/version-selector.js"></script></body></html>